---
title: "R Notebook"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r, setup, include=FALSE}

source('requirements.R')

# load dataset
source('load_data.R')

# load functions
source('functions.R')

# get queries
source('queries.R')

```

```{r}
# Show first 5 entries of dataset
so_20 <- dbGetByQuery("SELECT * FROM survey_results_public LIMIT 5")

so_20_schema <- dbGetByQuery("SELECT * FROM survey_results_schema LIMIT 5")

so_20[1:5,]

# TODO: Plot histogram?
```

# Initial Assessment
```{r}

#sprintf('The 2020 survey had %d respondents and %d variables.', dim(so_20)[1], dim(so_20)[2])

#head(so_20_schema)

```

```{r}
# Load world data
world <- ne_countries(scale = "medium", returnclass = "sf")

# Create dataframe with all available countries
worldframe <- data.frame(x = world$name)

# Create dataframe with all survey countries
df1 <- so_20 %>% count(Country)

# Rename col for joining
df1 <- df1 %>%
  rename(
    x = Country
  )

# Join both dataframes together
world$surveyPop <- join(worldframe, df1, by='x')

# Change NA to 0
world$surveyPop[is.na(world$surveyPop)] <- 0
```

# Geography

```{r}
# Plot world map
worldpopmap <- ggplot(data=world) +
  # Set plot title
  ggtitle("World map", subtitle = paste0("(", length(unique(world$name)), " countries)")) +
  # Set x and y label
  xlab("Longitude") + ylab("Latitude") +
  # Fill worldmap with summarized survey data
  geom_sf(aes(fill = world$surveyPop$n)) +
  # Scale colors
  scale_fill_viridis_c(option = "plasma", trans = "sqrt") +
  # Customize legend title
  labs(fill = 'Frequency')

# display map
worldpopmap

```

```{r}
# Show previously plotted data in numbers

so_20 %>% 
  count(Country) %>%
    arrange(-n)

```

# Developer Roles
About 55% of respondents identify as full-stack developers, and about 20% consider themselves mobile developers. The median number of developer type identifications per respondent this year is three, and the most common combinations include back-end, front-end, and full-stack developer. Pairs that are highly correlated include database administrator and system administrator, DevOps specialist and site reliability engineer, academic researcher and scientist, and designer and front-end developer.
```{r}

devTypes <- dbGetByCol(
  col = "DevType"
)

dT_split <- strsplit(devTypes$DevType, split=";")
dT_flatten <- unlist(dT_split)
dT <- data.frame(matrix(dT_flatten))

colnames(dT) <- colnames(devTypes)

dT %>% 
  ggplot( aes(x = fct_infreq(DevType))) + 
    geom_bar()+ 
    xlab("Dev Type") +
    coord_flip() +
    labs(y = 'Count', title= 'Developer Types')

```

## Coding as a hobby

Many developers work on code outside of work. About 78% of our respondents say that they code as a hobby. Other responsibilities outside of software can reduce developers' engagement in coding as a hobby; developers who say they have children or other caretaking responsibilities are less likely to code as a hobby. Respondents who are women are also less likely to say they code as a hobby.

```{r}
# TODO Respondents who are women are also less likely to say they code as a hobby.

hobby <- dbGetByCol(
  col = "Hobbyist"
)

hobby <- hobby %>% count(Hobbyist)

# Compute percentage
hobby$perc <- perc(hobby$n, length(so_20$Hobbyist))

hobby %>%
  ggplot( aes(x= Hobbyist, y= perc)) + 
    geom_bar(stat='identity') +
    xlab("") +
    coord_flip() +
    labs(y = 'Percentage', title= 'Coding as a Hobby')
```

# Experience
## Years since Learning to Code

There is a wide range of experience among developers who visit Stack Overflow, from seasoned developers who learned to code more than 30 years ago (approximately 15%), to a sizable percentage of developers (17%) who learned how to code less than five years ago. Of the professional developers on Stack Overflow, approximately 40% learned to code less than 10 years ago.

```{r}

exp <- dbGetByCol(
  col = "YearsCode"
)

# Create new dataframe for storage
newExp <- data.frame()
  
# Convert data to a numerical column
exp$nYearsCode <- as.integer(exp$YearsCode)
exp[grep('Less', exp$YearsCode),]$nYearsCode <- 0
exp[grep('More', exp$YearsCode),]$nYearsCode <- 50

# Select data relted for plotting

newExp['Less than 5 years', 'n'] <- (exp %>% filter(nYearsCode < 5))$n %>% sum() 
newExp['5 to 9 years', 'n'] <- (exp %>% filter(between(nYearsCode, 5, 9)))$n %>% sum()
newExp['10 to 14 years', 'n'] <- (exp %>% filter(between(nYearsCode, 10, 14)))$n %>% sum()
newExp['15 to 19 years', 'n'] <- (exp %>% filter(between(nYearsCode, 15, 19)))$n %>% sum()
newExp['20 to 24 years', 'n'] <- (exp %>% filter(between(nYearsCode, 20, 24)))$n %>% sum()
newExp['25 to 29 years', 'n'] <- (exp %>% filter(between(nYearsCode, 25, 29)))$n %>% sum()
newExp['30 to 34 years', 'n'] <- (exp %>% filter(between(nYearsCode, 30, 34)))$n %>% sum()
newExp['35 to 39 years', 'n'] <- (exp %>% filter(between(nYearsCode, 35, 39)))$n %>% sum()
newExp['40 to 44 years', 'n'] <- (exp %>% filter(between(nYearsCode, 40, 45)))$n %>% sum()
newExp['45 to 49 years', 'n'] <- (exp %>% filter(between(nYearsCode, 45, 49)))$n %>% sum()
newExp['50 years or more', 'n'] <- (exp %>% filter(nYearsCode >= 50))$n %>% sum() 

#
#between_c(exp, exp$YearsCode, 5, 9)$n

# Compute percentages
newExp$perc <- perc(newExp$n, sum(exp$n))

# Move idx names to a col
newExp$desc <- rownames(newExp)

# TODO fix order of plotting
# newExp$desc <- factor(newExp$desc, levels= newExp$desc[order(newExp$perc)])

newExp %>%
  ggplot( aes(x= rownames(newExp), y= perc)) + 
    geom_bar(stat='identity') +
    xlab("") +
    coord_flip() + 
    labs(y = 'Percentage', title='Years since learning to Code')

```


## Years of Professional Coding Experience by Developer Type
Technical executives and engineering managers tend to have the most professional coding experience. Among the individual contributor roles, the most experienced developers tend to be system administrators, database administrators, and developers who create desktop and embedded applications. On the other end of the spectrum, web developers, academic researchers, and data scientists tend to have fewer years of experience. Part of this could be explained by the proliferation of coding bootcamps that teach web development and the amount of data scientists entering the field from academia.

```{r}
# test
```

## Writing That First Line of Code
Of all of the respondents, over 54% wrote their first line of code, whether it was a web page or a hello world program, by the age of 16. People who wrote their first line of code in their 20s accounted for 13% of the respondents. When looking at the average age by country, respondents from countries such as Brazil and India tend to start writing code a full two years later compared to developers in countries such as Poland and Germany, who on average start coding by the age of 15.

```{r}
fcode <- dbGetByCol(
  col = "Age1stCode"
)

newFCode <- data.frame()

# Convert data to a numerical column
fcode$nAge1stCode <- as.integer(fcode$Age1stCode)


fcode

# Make string col readable
fcode[grep('Younger', fcode$Age1stCode),]$nAge1stCode <- 10
fcode[grep('Older', fcode$Age1stCode),]$nAge1stCode <- 30

# Select data related for plotting

newFCode['Younger than 10 years', 'n'] <- (fcode %>% filter(nAge1stCode < 10))$n %>% sum()
newFCode['10 to 11 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 10, 11)))$n %>% sum()
newFCode['12 to 13 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 12, 13)))$n %>% sum()
newFCode['14 to 15 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 14, 15)))$n %>% sum()
newFCode['16 to 17 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 16, 17)))$n %>% sum()
newFCode['18 to 19 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 18, 19)))$n %>% sum()
newFCode['20 to 21 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 20, 21)))$n %>% sum()
newFCode['22 to 23 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 22, 23)))$n %>% sum()
newFCode['24 to 25 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 24, 25)))$n %>% sum()
newFCode['26 to 27 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 26, 27)))$n %>% sum()
newFCode['28 to 29 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 28, 29)))$n %>% sum()
newFCode['30 years old or older', 'n'] <- (fcode %>% filter(nAge1stCode >= 30))$n %>% sum() 

# Print sum of rows to check if all rows have been added
newFCode %>% sum()

#
#between_c(exp, exp$YearsCode, 5, 9)$n

# Compute percentages
newFCode$perc <- perc(newFCode$n, sum(fcode$n))

# Move idx names to a col
newFCode$desc <- rownames(newFCode)

# TODO fix order of plotting
# newExp$desc <- factor(newExp$desc, levels= newExp$desc[order(newExp$perc)])

newFCode %>%
  ggplot( aes(x= rownames(newFCode), y= perc)) + 
    geom_bar(stat='identity') +
    xlab("") +
    coord_flip() + 
    labs(y = 'Percentage', title='Writing That First Line of Code')
```
```{r}
fcode_country <- data.frame(so_20$Age1stCode, so_20$Country)

fcode_country <- fcode_country %>% na.omit(fcode_country)

fcode_country

# aggregate(fcode_country, by=list(fcode_country$so_20.Age1stCode), FUN=sum)
```


# Education
## Educational Attainment
Approximately 75% of respondents worldwide completed at least the equivalent of a bachelor's degree or higher. This is consistent with what we've seen in previous years.

```{r}

edu <- dbGetByCol(
  col = "EdLevel"
)

edu %>% 
  count(EdLevel) %>% 
    ggplot( aes(x=EdLevel, y=n)) + 
      geom_bar(stat='identity') +
      xlab("") +
      coord_flip() +
      labs(y = 'Cumulative Number', title= 'Educational Attainment')

```

## Undergraduate Major
There are a variety of academic paths to becoming a professional software developer. Of the respondents that write code professionally and studied at the university level, over 62% have a degree in computer science, computer engineering, or software engineering and just under 10% have a degree in another engineering field. Interestingly enough, almost 10% of the respondents have a business related degree or a degree in a humanities, social science, or fine arts field of study.

```{r}
# test
```


```{r}
# https://insights.stackoverflow.com/survey/2020#developer-profile-developer-type-united-states-unweighted
```





