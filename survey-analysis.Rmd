---
title: "R Notebook"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r, setup, include=FALSE}

source('requirements.R')

# load dataset
source('db.R')

# load functions
source('functions.R')

# get queries
source('queries.R')

```

```{r}
# Show first 5 entries of dataset
so_20 <- dbGetByQuery("SELECT * FROM survey_results_public LIMIT 5")

so_20_schema <- dbGetByQuery("SELECT * FROM survey_results_schema LIMIT 5")

so_20[1:5,]

# TODO: Plot histogram?
```

# Initial Assessment
```{r}

#sprintf('The 2020 survey had %d respondents and %d variables.', dim(so_20)[1], dim(so_20)[2])

#head(so_20_schema)

```

```{r}
# Load world data
world <- ne_countries(scale = "medium", returnclass = "sf")

# Create dataframe with all available countries
worldframe <- data.frame(x = world$name)

# Create dataframe with all survey countries
countries <- dbGetByCol(
  col = "Country"
)

countries <- countries %>% count(Country)

# Rename col for joining
countries <- countries %>%
  rename(
    x = Country
  )

# Join both dataframes together
world$surveyPop <- join(worldframe, countries, by='x')

# Change NA to 0
world$surveyPop[is.na(world$surveyPop)] <- 0
```

# Geography

```{r}
# Plot world map
worldpopmap <- ggplot(data=world) +
  # Set plot title
  ggtitle("World map", subtitle = paste0("(", length(unique(world$name)), " countries)")) +
  # Set x and y label
  xlab("Longitude") + ylab("Latitude") +
  # Fill worldmap with summarized survey data
  geom_sf(aes(fill = world$surveyPop$n)) +
  # Scale colors
  scale_fill_viridis_c(option = "plasma", trans = "sqrt") +
  # Customize legend title
  labs(fill = 'Frequency')

# display map
worldpopmap

```

```{r}
# Show previously plotted data in numbers

countries %>%
  arrange(-n)

```

# Developer Roles
About 55% of respondents identify as full-stack developers, and about 20% consider themselves mobile developers. The median number of developer type identifications per respondent this year is three, and the most common combinations include back-end, front-end, and full-stack developer. Pairs that are highly correlated include database administrator and system administrator, DevOps specialist and site reliability engineer, academic researcher and scientist, and designer and front-end developer.
```{r}

devTypes <- dbGetByCol(
  col = "DevType"
)

dT_split <- strsplit(devTypes$DevType, split=";")
dT_flatten <- unlist(dT_split)
dT <- data.frame(matrix(dT_flatten))

colnames(dT) <- colnames(devTypes)

dT %>% 
  ggplot( aes(x = fct_infreq(DevType))) + 
    geom_bar(fill='steelblue')+ 
    xlab("Dev Type") +
    coord_flip() +
    labs(title = "Developer Types",
         subtitle = paste0("All Respondents (", nrow(devTypes) ,")"),
         y = 'Count')
```


## Job Satisfactory
```{r}

sat <- dbGetByCol(
  col = "JobSat"
)

# Plot Overall Satisfactory
sat %>% count(JobSat) %>% arrange(n) %>% mutate(pct = prop.table(n), JobSat = fct_reorder(JobSat, n)) %>%
  ggplot(aes(
    x=JobSat, 
    y=n,
    label= scales::percent(pct))) +
    
    geom_col(position = 'dodge', fill = 'steelblue') + 
    geom_text(position = position_dodge(width = .9),    # move to center of bars
              vjust = 0.5,    # nudge above top of bar
              size = 3) + 
    xlab("Level of Job Satisfactory") +
    ylab("Amount of Respondents") +
    labs(title = "Overall Satisfactory",
         subtitle = paste0("All Respondents (", nrow(sat) ,")")) +
    coord_flip()

# Plot Satisfactory dependent with educational attainment

satByEdu <- dbGetByQuery(
  query = "SELECT count(JobSat) as cJobSat,JobSat,EdLevel
FROM survey_results_public
WHERE JobSat IS NOT NULL
AND EdLevel IS NOT NULL
GROUP BY JobSat, EdLevel
ORDER BY cJobSat DESC;" 
)

satByEdu[,"cJobSat"] <- as.integer(satByEdu[,"cJobSat"])

satByEdu %>% 
  ggplot(aes(
    x = JobSat,
    y = cJobSat,
    fill = EdLevel
  )) + geom_bar(stat = "identity") + 
  theme(legend.position="bottom", 
        legend.box="vertical", 
        legend.margin=margin()
        ) +
  ylab("Count") + xlab("Level of Satisfaction") +
  labs(
    fill = "Educational Attainment",
    title = "Overall Satisfactory by Educational Attainment",
    subtitle = paste0("All Respondents (", sum(satByEdu$cJobSat) ,")")
  ) + coord_flip()

```



## Coding as a hobby

Many developers work on code outside of work. About 78% of our respondents say that they code as a hobby. Other responsibilities outside of software can reduce developers' engagement in coding as a hobby; developers who say they have children or other caretaking responsibilities are less likely to code as a hobby. Respondents who are women are also less likely to say they code as a hobby.

```{r}
hobby <- dbGetByQuery("SELECT 
Hobbyist, 
count(Hobbyist) as CountHobbyist, 
Gender 
FROM new_schema.survey_results_public
WHERE
Gender = 'Woman' or
Gender = 'Man'
group by 
Hobbyist,
Gender;
")

hobby[,"CountHobbyist"] <- as.integer(hobby[,"CountHobbyist"])

hobby <- hobby %>% mutate(pct = prop.table(CountHobbyist))

# Create reusable plot without data
gg_hobby <- ggplot(data = data.frame(), aes(x = Hobbyist, 
                                            y = CountHobbyist, 
                                            fill=Gender,
                                            label= scales::percent(pct))) +
  geom_col(position = 'dodge') + 
  geom_text(position = position_dodge(width = .9),    # move to center of bars
              vjust = -0.5,    # nudge above top of bar
              size = 3) + 
  labs(x = 'Hobbyist', 
       y = NULL, 
       fill= 'Gender', 
       title= 'Amount of Hobbyists by Gender',
       subtitle= paste0("All Respondents (", sum(hobby$CountHobbyist) ,")"))

# Add data after
gg_hobby %+%
  hobby


```

# Experience
## Years since Learning to Code

There is a wide range of experience among developers who visit Stack Overflow, from seasoned developers who learned to code more than 30 years ago (approximately 15%), to a sizable percentage of developers (17%) who learned how to code less than five years ago. Of the professional developers on Stack Overflow, approximately 40% learned to code less than 10 years ago.

```{r}

exp <- dbGetByCol(
  col = "YearsCode"
)



# Create new dataframe for storage
newExp <- data.frame()
  
# Convert data to a numerical column
exp$nYearsCode <- as.integer(exp$YearsCode)
exp[grep('Less', exp$YearsCode),]$nYearsCode <- 0
exp[grep('More', exp$YearsCode),]$nYearsCode <- 50

# Select data relted for plotting

newExp['Less than 5 years', 'n'] <- (exp %>% filter(nYearsCode < 5))$n %>% sum() 
newExp['5 to 9 years', 'n'] <- (exp %>% filter(between(nYearsCode, 5, 9)))$n %>% sum()
newExp['10 to 14 years', 'n'] <- (exp %>% filter(between(nYearsCode, 10, 14)))$n %>% sum()
newExp['15 to 19 years', 'n'] <- (exp %>% filter(between(nYearsCode, 15, 19)))$n %>% sum()
newExp['20 to 24 years', 'n'] <- (exp %>% filter(between(nYearsCode, 20, 24)))$n %>% sum()
newExp['25 to 29 years', 'n'] <- (exp %>% filter(between(nYearsCode, 25, 29)))$n %>% sum()
newExp['30 to 34 years', 'n'] <- (exp %>% filter(between(nYearsCode, 30, 34)))$n %>% sum()
newExp['35 to 39 years', 'n'] <- (exp %>% filter(between(nYearsCode, 35, 39)))$n %>% sum()
newExp['40 to 44 years', 'n'] <- (exp %>% filter(between(nYearsCode, 40, 45)))$n %>% sum()
newExp['45 to 49 years', 'n'] <- (exp %>% filter(between(nYearsCode, 45, 49)))$n %>% sum()
newExp['50 years or more', 'n'] <- (exp %>% filter(nYearsCode >= 50))$n %>% sum() 

#
#between_c(exp, exp$YearsCode, 5, 9)$n

# Compute percentages
newExp$perc <- perc(newExp$n, sum(exp$n))

# Move idx names to a col
newExp$desc <- rownames(newExp)

newExp %>%
  mutate(desc = fct_reorder(desc, desc(-n))) %>%
  ggplot(aes(x= desc, y= perc)) + 
    geom_bar(stat='identity', fill='steelblue') +
    xlab("") +
    coord_flip() + 
    labs(y = 'Percentage', 
         title='Years since learning to Code',
         subtitle = paste0("All Respondents (", nrow(exp) ,")"))

```


## Years of Professional Coding Experience by Developer Type
Technical executives and engineering managers tend to have the most professional coding experience. Among the individual contributor roles, the most experienced developers tend to be system administrators, database administrators, and developers who create desktop and embedded applications. On the other end of the spectrum, web developers, academic researchers, and data scientists tend to have fewer years of experience. Part of this could be explained by the proliferation of coding bootcamps that teach web development and the amount of data scientists entering the field from academia.

```{r}
# test
```

## Writing That First Line of Code
Of all of the respondents, over 54% wrote their first line of code, whether it was a web page or a hello world program, by the age of 16. People who wrote their first line of code in their 20s accounted for 13% of the respondents. When looking at the average age by country, respondents from countries such as Brazil and India tend to start writing code a full two years later compared to developers in countries such as Poland and Germany, who on average start coding by the age of 15.

```{r}
fcode <- dbGetByCol(
  col = "Age1stCode"
)

newFCode <- data.frame()

# Convert data to a numerical column
fcode$nAge1stCode <- as.integer(fcode$Age1stCode)


fcode

# Make string col readable
fcode[grep('Younger', fcode$Age1stCode),]$nAge1stCode <- 10
fcode[grep('Older', fcode$Age1stCode),]$nAge1stCode <- 30

# Select data related for plotting

newFCode['Younger than 10 years', 'n'] <- (fcode %>% filter(nAge1stCode < 10))$n %>% sum()
newFCode['10 to 11 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 10, 11)))$n %>% sum()
newFCode['12 to 13 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 12, 13)))$n %>% sum()
newFCode['14 to 15 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 14, 15)))$n %>% sum()
newFCode['16 to 17 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 16, 17)))$n %>% sum()
newFCode['18 to 19 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 18, 19)))$n %>% sum()
newFCode['20 to 21 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 20, 21)))$n %>% sum()
newFCode['22 to 23 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 22, 23)))$n %>% sum()
newFCode['24 to 25 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 24, 25)))$n %>% sum()
newFCode['26 to 27 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 26, 27)))$n %>% sum()
newFCode['28 to 29 years old', 'n'] <- (fcode %>% filter(between(nAge1stCode, 28, 29)))$n %>% sum()
newFCode['30 years old or older', 'n'] <- (fcode %>% filter(nAge1stCode >= 30))$n %>% sum() 

# Print sum of rows to check if all rows have been added
newFCode %>% sum()

# Compute percentages
newFCode$perc <- perc(newFCode$n, sum(fcode$n))

# Move idx names to a col
newFCode$desc <- rownames(newFCode)

newFCode %>%
  mutate(desc = fct_reorder(desc, desc(-n))) %>%
  ggplot( aes(x= desc, y= perc)) + 
    geom_bar(stat='identity', fill='steelblue') +
    xlab("") +
    coord_flip() + 
    labs(y = 'Percentage', title='Writing That First Line of Code',
         subtitle = paste0("All Respondents (", nrow(fcode) ,")"))
```
```{r}

fcode_country <- data.frame(so_20$Age1stCode, so_20$Country)

fcode_country <- fcode_country %>% na.omit(fcode_country)

fcode_country

```


# Education
## Educational Attainment
Approximately 75% of respondents worldwide completed at least the equivalent of a bachelor's degree or higher. This is consistent with what we've seen in previous years.

```{r}

edu <- dbGetByCol(
  col = "EdLevel"
)

edu %>% 
  count(EdLevel) %>%
  mutate(EdLevel = fct_reorder(EdLevel, desc(-n))) %>%
    ggplot( aes(x=EdLevel, y=n)) + 
      geom_bar(stat='identity', fill='steelblue') +
      xlab("") +
      coord_flip() +
      labs(y = 'Cumulative Number', title= 'Educational Attainment',
           subtitle = paste0("All Respondents (", nrow(edu) ,")"))

```

## Undergraduate Major
There are a variety of academic paths to becoming a professional software developer. Of the respondents that write code professionally and studied at the university level, over 62% have a degree in computer science, computer engineering, or software engineering and just under 10% have a degree in another engineering field. Interestingly enough, almost 10% of the respondents have a business related degree or a degree in a humanities, social science, or fine arts field of study.

```{r}
# test
```


```{r}
# https://insights.stackoverflow.com/survey/2020#developer-profile-developer-type-united-states-unweighted
```


# Salary

```{r}

salaryByDevType <- dbGetByQuery(query = "SELECT DevType, Gender, CompTotal
FROM survey_results_public
WHERE GENDER = 'Woman' OR GENDER = 'Man'
AND CONCAT(DevType, Gender, CompTotal) IS NOT NULL
AND CompTotal > 20000 AND CompTotal < 500000;")


salaryByDevType <- separate(data = salaryByDevType, col = DevType, sep = (";"), into=c(LETTERS[1:8]), extra = "drop", fill = "right")

d = c()
g = c()
s = c()

for (col in 1:8) {
  for (row in 0:nrow(salaryByDevType)) {
    d <- c(d, salaryByDevType[row, col])
    g <- c(g, salaryByDevType[row, "Gender"])
    s <- c(s, salaryByDevType[row, "CompTotal"])
  }
}

# Create data frame from three vectors
df <- data.frame(d,g,s) %>% na.omit()

# Set colnames
colnames(df) <- c("DevType", "Gender", "Salary")

# Change col type
df$Salary <- as.integer(df$Salary)

# Compute amount of occurrences
count <- ddply(df, .(df$DevType, df$Gender), nrow)["V1"]

# Compute mean salary and group by DevType and Gender
df <- df %>% group_by(DevType, Gender) %>% summarise(Salary = mean(Salary)) 

df["Count"] <- count

# Deselect all values below 500k - its unreal to have a mean above it
df <- df[which(df$Salary < 200000), ] 

# df <- df[which(df$Count < 250), ]

df %>% ggplot(aes(
  x = Count,
  y = Salary
)) + geom_point() + geom_label(label=df$DevType, aes(colour = Gender), vjust = "inward", hjust = "inward" )

```



